<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link th:rel="stylesheet" th:href="@{/webjars/bootstrap/5.1.3/css/bootstrap.min.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/application.css}">
    <title th:text="|Edit ${ticket.titolo}|">Edit Ticket</title>

    <style>
        :root {
            --accent: #48f5b6;
            --accent-2: #66d9ff;
            --bg-1: #071428;
            --bg-2: #042033;
            --glass: rgba(255,255,255,0.04);
        }

        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', 'Share Tech Mono', monospace;
            color: rgba(230,247,242,0.95);
        }

        body {
            background: linear-gradient(135deg, var(--bg-1), var(--bg-2));
            overflow-x: hidden;
        }

        #matrix {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            mix-blend-mode: screen;
            opacity: 0.5;
            filter: blur(0.6px) saturate(1.05);
        }

        .page-overlay {
            position: fixed;
            inset: 0;
            z-index: 1;
            background: radial-gradient(ellipse at center, rgba(4,10,18,0) 0%, rgba(2,6,10,0.35) 80%);
            pointer-events: none;
        }

        .card {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border: 1px solid rgba(72,245,182,0.08);
            border-radius: 12px;
            backdrop-filter: blur(6px);
            box-shadow: 0 8px 30px rgba(2,6,10,0.5);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(72,245,182,0.15);
        }

        .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(72,245,182,0.06);
            color: rgba(230,247,242,0.95);
        }

        h3, h5, h6 {
            color: #e6f7f2;
            text-shadow: 0 6px 18px rgba(0,0,0,0.6);
        }

        .badge {
            font-weight: bold;
            text-shadow: 0 0 3px var(--accent);
        }

        .badge.bg-danger { background-color: #ff4d4d; color: #0d1117; }
        .badge.bg-warning { background-color: #f8ff8a; color: #000; }
        .badge.bg-success { background-color: #48f5b6; color: #000; }
        .text-muted { color: rgba(230,247,242,0.7) !important; }

        .btn-primary,
        .btn-outline-info,
        .btn-outline-warning,
        .btn-outline-danger {
            background-color: transparent;
            color: var(--accent);
            border: 1px solid rgba(72,245,182,0.16);
        }

        .btn-primary:hover,
        .btn-outline-info:hover,
        .btn-outline-warning:hover,
        .btn-outline-danger:hover {
            background: linear-gradient(90deg, rgba(72,245,182,0.95), rgba(102,217,255,0.9));
            color: #02121a;
            box-shadow: 0 14px 40px rgba(72,245,182,0.12);
            transform: translateY(-2px);
        }

        hr {
            border-color: rgba(72,245,182,0.15);
        }

        /* CAMPI TESTO - input, select, textarea */
        .form-control,
        .form-select,
        textarea,
        input {
            background: rgba(20,20,30,0.85);  /* sfondo scuro ma trasparente */
            color: #000000 !important;        /* testo nero */
            border: 1px solid rgba(100,150,255,0.4); /* bordo blu elegante */
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        /* Placeholder nero chiaro */
        .form-control::placeholder,
        .form-select::placeholder,
        textarea::placeholder,
        input::placeholder {
            color: rgba(0,0,0,0.4) !important;
        }

        /* Focus */
        .form-control:focus,
        .form-select:focus,
        textarea:focus,
        input:focus {
            color: #000000 !important;        /* testo nero a focus */
            border-color: rgba(100,150,255,0.7); /* bordo blu a focus */
            box-shadow: 0 0 10px rgba(100,150,255,0.5); /* bagliore blu delicato */
        }
    </style>
</head>

<body>
<canvas id="matrix"></canvas>
<div class="page-overlay"></div>

<nav th:replace="~{navbar :: navbar('Home')}"></nav>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3 class="mb-0">Edit Ticket</h3>
                </div>
                <div class="card-body p-4">
                    <form th:object="${ticket}" th:action="@{/tickets/edit/{id}(id=${ticket.id})}" method="post">
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />

                        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger" role="alert">
                            <strong>Validation Errors:</strong>
                            <ul class="mb-0">
                                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                            </ul>
                        </div>

                        <div class="row">
                            <div class="col-lg-8">
                                <div class="row gy-3">
                                    <!-- Title -->
                                    <div class="col-12">
                                        <label class="form-label fw-semibold" for="titolo">Title</label>
                                        <input id="titolo" type="text" class="form-control" th:field="*{titolo}" th:attr="readonly=${!isAdmin}" />
                                    </div>

                                    <!-- Description -->
                                    <div class="col-12">
                                        <label class="form-label fw-semibold" for="description">Description</label>
                                        <textarea id="description" class="form-control" th:field="*{description}" rows="5" th:attr="readonly=${!isAdmin}"></textarea>
                                    </div>

                                    <!-- Status -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold" for="status">Status</label>
                                        <select id="status" class="form-select" th:field="*{status}" th:attr="disabled=${!(isAdmin or (isOperator and ticket.user.username == #authentication.name))}">
                                            <option th:each="item : ${statusNamesList}" th:value="${item}" th:text="${item}"></option>
                                        </select>
                                        <input type="hidden" th:if="${!(isAdmin or (isOperator and ticket.user.username == #authentication.name))}" th:field="*{status}" />
                                    </div>

                                    <!-- Category -->
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold" for="category">Category</label>
                                        <select id="category" class="form-select" th:field="*{category.id}" th:attr="disabled=${!isAdmin}">
                                            <option value="">Select a category</option>
                                            <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
                                        </select>
                                        <input type="hidden" th:if="${!isAdmin}" th:field="*{category.id}" />
                                    </div>

                                    <!-- Operator -->
                                    <div class="col-md-12">
                                        <label class="form-label fw-semibold" for="user">Operator</label>
                                        <select id="user" class="form-select" th:field="*{user.id}" th:attr="disabled=${!isAdmin}">
                                            <option value="">Select an Operator</option>
                                            <option th:each="operator : ${operators}" th:value="${operator.id}" th:text="${operator.username}"></option>
                                        </select>
                                        <input type="hidden" th:if="${!isAdmin}" th:field="*{user.id}" />
                                    </div>

                                    <!-- Buttons -->
                                    <div class="col-12 mt-4">
                                        <button type="submit" class="btn btn-primary">Save Ticket</button>
                                        <a th:href="@{/tickets}" class="btn btn-outline-info">Cancel</a>
                                    </div>
                                </div>
                            </div>

                            <!-- Sidebar info -->
                            <div class="col-lg-4">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3" style="color:var(--accent)">Information</h5>
                                        <div class="mb-3">
                                            <small class="text-muted d-block mb-1">Available Statuses:</small>
                                            <div>
                                                <span class="badge me-1" style="background-color:#4dabf7; color:#0d1117;">TO_DO</span>
                                                <span class="badge me-1" style="background-color:#1c7ed6; color:#ffffff;">IN_PROGRESS</span>
                                                <span class="badge" style="background-color:#0b3d91; color:#ffffff;">COMPLETED</span>
                                            </div>
                                        </div>
                                        <hr>
                                        <small class="text-muted">
                                            <strong>Note:</strong> Only admins or assigned operators can edit certain fields.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/webjars/bootstrap/5.1.3/js/bootstrap.bundle.min.js}"></script>

<script>
    const c = document.getElementById("matrix");
    const ctx = c.getContext("2d");

    function resetCanvas(){ c.width=window.innerWidth; c.height=window.innerHeight; }
    resetCanvas();

    let letters = "abcdefghijklmnopqrstuvwxyz0123456789@#";
    const fontSize = 14;
    let columns = Math.floor(c.width / fontSize);
    let drops = Array(columns).fill(1);

    window.addEventListener('resize', ()=>{
        resetCanvas();
        columns = Math.floor(c.width / fontSize);
        drops = Array(columns).fill(1);
    });

    function draw(){
        ctx.fillStyle = "rgba(6,10,14,0.12)";
        ctx.fillRect(0,0,c.width,c.height);
        ctx.fillStyle = "rgba(72,245,182,0.82)";
        ctx.font = fontSize+"px monospace";
        for(let i=0;i<drops.length;i++){
            const text = letters.charAt(Math.floor(Math.random()*letters.length));
            const x = i*fontSize;
            const y = drops[i]*fontSize;
            ctx.fillText(text,x,y);
            if(y>c.height && Math.random()>0.98) drops[i]=0;
            drops[i]++;
        }
    }

    let then=0, fps=30;
    function animate(now){
        requestAnimationFrame(animate);
        const elapsed = now-then;
        if(elapsed > (1000/fps)){ then=now; draw(); }
    }
    requestAnimationFrame(animate);
</script>

</body>
</html>